// Generated by CoffeeScript 1.7.1
var Renderer, aggregate, dependable, events, express, fs, glob, mongoose, path, postrender, swig, vhosted, _;

express = require('express');

mongoose = require('mongoose');

dependable = require('dependable');

postrender = require('express-postrender');

swig = require('swig');

path = require('path');

glob = require('glob');

events = require('events');

fs = require('fs');

vhosted = require('vhosted');

_ = require('lodash');

Renderer = (function() {
  function Renderer(filename, renderer, cache, locals) {
    this.filename = filename;
    this.renderer = renderer;
    this.cache = cache;
    this.locals = locals;
    return;
  }

  Renderer.prototype.render = function(req, res, options, fn) {
    var err, opts;
    options = options || {};
    if (_.isFunction(options)) {
      fn = options;
      options = {};
    }
    fn = fn || function(err, str) {
      if (err) {
        return req.next(err);
      }
      res.send(str);
    };
    opts = {};
    opts = _.assign(opts, this.locals);
    opts = _.assign(opts, res.locals);
    opts = _.assign(opts, options);
    opts.cache = opts.cache == null ? this.cache : opts.cache;
    opts.filename = this.filename;
    try {
      this.renderer(this.filename, opts, fn);
    } catch (_error) {
      err = _error;
      fn(err);
    }
  };

  return Renderer;

})();

aggregate = function(collection, file, dir, value) {
  var chunks, cursor, i, _i, _ref, _results;
  chunks = path.relative(dir, file.replace(/\.[^.]+$/, '')).split(path.sep);
  cursor = collection;
  _results = [];
  for (i = _i = 0, _ref = chunks.length - 1; _i <= _ref; i = _i += 1) {
    if (i < chunks.length - 1) {
      if (collection[chunks[i]] == null) {
        _results.push(cursor = collection[chunks[i]] = {});
      } else {
        _results.push(cursor = collection[chunks[i]]);
      }
    } else {
      _results.push(cursor[chunks[i]] = value);
    }
  }
  return _results;
};

module.exports = function(projectDir, appDir, ext) {
  var app, assetFile, assets, chainware, config, dir, init, initialized, injector, injectors, load, loaded, name, pkg, publicDir, relativeAppDir, relativeProjectDir, routed, router;
  relativeProjectDir = path.relative(__dirname, projectDir);
  relativeAppDir = path.relative(__dirname, appDir);
  if (process.env.NODE_ENV == null) {
    process.env.NODE_ENV = 'development';
  }
  pkg = require(path.join(projectDir, 'package.json'));
  name = pkg.name;
  publicDir = path.join(projectDir, "public/" + name);
  dir = {
    project: projectDir,
    "public": publicDir,
    plugins: "" + projectDir + "/plugins",
    vhosts: "" + projectDir + "/vhosts",
    app: appDir
  };
  if (fs.existsSync("" + appDir + "/chainware" + ext)) {
    chainware = require("" + relativeAppDir + "/chainware");
  }
  injector = dependable.container();
  injector.register('$injector', injector);
  injector.register('$env', process.env.NODE_ENV);
  injector.register('$dir', dir);
  injector.register('$ext', ext);
  injector.register('$name', name);
  injector.register('$assets', {
    js: {},
    css: {},
    other: {}
  });
  injector.register('$mount', '/', injector.register('$plugin', {
    register: function(plugin, shared) {
      var a, assets, injectors, k, pluginAssets, v, _ref;
      if (fs.existsSync("" + plugin + ext)) {
        plugin = require("" + plugin + ext);
      } else if (fs.existsSync("" + plugin + ".js")) {
        plugin = require("" + plugin + ".js");
      } else {
        plugin = require(plugin);
      }
      if ((shared == null) || shared === true) {
        plugin.injector.register('__shared', true);
        plugin.injector.register('$connection', function() {
          return injector.get('$connection');
        });
        plugin.injector.register('$mongoose', function() {
          return injector.get('$mongoose');
        });
      }
      assets = injector.get('$assets');
      pluginAssets = plugin.injector.get('$assets');
      if (pluginAssets[name] == null) {
        pluginAssets[name] = assets;
      }
      plugin.injector.register('$assets', pluginAssets);
      plugin.load();
      injectors = injector.get('$injectors');
      _ref = plugin.injector.get('$injectors');
      for (k in _ref) {
        v = _ref[k];
        if (injectors[k] == null) {
          injectors[k] = v;
        }
        if ((assets[k] == null) && k !== name) {
          a = v.get('$assets');
          if (a[name] != null) {
            delete a[name];
          }
          assets[k] = a;
        }
      }
    },
    get: function(plugin) {
      return injectors[plugin].get('$router');
    }
  }));
  injector.register('$express', function() {
    return express;
  });
  injector.register('$dependable', function() {
    return dependable;
  });
  injector.register('$glob', function() {
    return glob;
  });
  injector.register('$lodash', function() {
    return _;
  });
  injectors = {};
  injectors[name] = injector;
  injector.register('$injectors', injectors);
  injector.register('__shared', false);
  config = {};
  config.database = {};
  config.database.uri = 'mongodb://localhost/meanstackjs';
  config.database.options = {};
  config.secret = 'meanstackjs';
  config.mount = '/';
  config.port = 3000;
  config.router = {
    caseSensitive: false,
    strict: false
  };
  config["static"] = {};
  config["static"].expiry = 0;
  if (process.env.NODE_ENV === 'production') {
    config["static"].expiry = 1000 * 3600 * 24 * 365;
  }
  config.middleware = {};
  config.middleware['vhosted'] = true;
  config.middleware['compression'] = {
    threshold: 0,
    level: 9
  };
  config.middleware['cookie-parser'] = true;
  config.middleware['body-parser'] = true;
  config.middleware['express-validator'] = true;
  config.middleware['method-override'] = true;
  config.middleware['express-session'] = {
    key: 'sid'
  };
  config.middleware['connect-mongo'] = true;
  config.middleware['view-helpers'] = true;
  config.middleware['connect-flash'] = true;
  config.middleware['serve-favicon'] = false;
  config.middleware['errorhandler'] = true;
  if (process.env.NODE_ENV === 'production') {
    config.middleware['errorhandler'] = false;
  }
  config.views = {};
  config.views.dir = path.resolve("" + appDir + "/");
  if (process.env.NODE_ENV === 'production') {
    config.views.cache = true;
  } else {
    config.views.cache = false;
  }
  config.views.callback = function(html) {
    return html;
  };
  config.views.extension = 'html';
  injector.register('$config', config);
  if ((chainware != null ? chainware.config : void 0) != null) {
    injector.resolve(chainware.config);
  }
  if (config.mount[config.mount.length - 1] !== '/') {
    config.mount += '/';
  }
  assetFile = path.join(publicDir, 'assets.json');
  if (fs.existsSync(assetFile)) {
    assets = JSON.parse(fs.readFileSync(assetFile));
    injector.register('$assets', assets);
  }
  app = express();
  injector.register('$app', function() {
    return app;
  });
  assets = injector.get('$assets');
  app.locals.assets = assets;
  app.locals.mount = config.mount;
  app.locals.name = name;
  router = express.Router(config.router);
  injector.register('$router', function() {
    return router;
  });
  injector.register('$route', function() {
    return express.Router(config.router);
  });
  routed = false;
  injector.register('__route', function() {
    return function() {
      if (routed) {
        return;
      }
      routed = true;
      if ((chainware != null ? chainware.dependencies : void 0) != null) {
        injector.resolve(chainware.dependencies);
      }
      if ((chainware != null ? chainware.routes : void 0) != null) {
        return injector.resolve(chainware.routes);
      }
    };
  });
  loaded = false;
  load = function() {
    var connected, connection, emitter, engine, globDir, i, k, resolve, v, views, __shared;
    if (loaded) {
      return;
    }
    loaded = true;
    __shared = injector.get('__shared');
    if ((chainware != null ? chainware.beforeLoad : void 0) != null) {
      injector.resolve(chainware.beforeLoad);
    }
    if (config.middleware['cookie-parser']) {
      config.middleware['cookie-parser'] = config.secret;
    }
    if (config.middleware['express-session']) {
      config.middleware['express-session']['secret'] = config.secret;
    }
    emitter = new events.EventEmitter();
    injector.register('$emitter', function() {
      return emitter;
    });
    if (!__shared) {
      connected = function() {
        return emitter.emit('mongoose-connected');
      };
      if (_.size(config.database.options) > 0) {
        connection = mongoose.createConnection(config.database.uri, config.database.options, connected);
      } else {
        connection = mongoose.createConnection(config.database.uri, connected);
      }
      injector.register('$connection', function() {
        return connection;
      });
      injector.register('$mongoose', function() {
        return mongoose;
      });
    }
    if (chainware != null ? chainware.plugins : void 0) {
      injector.resolve(chainware.plugins);
    }
    if (config.views.render == null) {
      if (config.views.cache) {
        engine = new swig.Swig({
          loader: swig.loaders.fs(config.views.dir),
          cache: 'memory'
        });
        app.locals.cache = 'memory';
      } else {
        engine = new swig.Swig({
          loader: swig.loaders.fs(config.views.dir),
          cache: false
        });
        app.locals.cache = false;
      }
      config.views.render = engine.renderFile;
    }
    app.set('view cache', config.views.cache);
    app.set('views', config.views.dir);
    views = {};
    config.views = postrender(config.views, config.views.callback, 'render');
    app.set('view engine', config.views.extension);
    app.engine(config.views.extension, config.views.render);
    globDir = path.resolve("" + config.views.dir + "/**/*." + config.views.extension);
    glob(globDir, {
      sync: true
    }, function(err, files) {
      var file, renderer, _i, _len, _results;
      if (err) {
        console.log(err);
        process.exit(0);
      }
      _results = [];
      for (_i = 0, _len = files.length; _i < _len; _i++) {
        file = files[_i];
        renderer = new Renderer(file, config.views.render, config.views.cache, app.locals);
        _results.push(aggregate(views, file, config.views.dir, renderer));
      }
      return _results;
    });
    for (k in injectors) {
      v = injectors[k];
      if (k !== name) {
        views[k] = v.get('$views');
      }
    }
    injector.register('$views', views);
    resolve = function(prop, key) {
      var args, construct, create, filter, get, i, match, overrides, r, singleton, wrap;
      filter = function(instance) {
        return instance;
      };
      wrap = function(instance) {
        return function() {
          return instance;
        };
      };
      get = function(instance) {
        return function() {
          var r;
          for (k in injectors) {
            v = injectors[k];
            if (instance.substring(0, k.length).replace('.', '-') === k) {
              r = instance.substring(k.length + 1);
              if (r.length > 0) {
                return v.get(r);
              }
            }
          }
          return injector.get(instance);
        };
      };
      construct = function(key, instance, args) {
        return function() {
          injector.register(key, construct(key, instance, args));
          return instance.construct(args);
        };
      };
      create = function(key, instance, args) {
        return function() {
          injector.register(key, create(key, instance, args));
          return injector.get(instance, args);
        };
      };
      if (prop.singleton != null) {
        singleton = prop.singleton;
      } else {
        singleton = true;
      }
      if (_.isFunction(prop)) {
        if ((prop.inject != null) || prop.name.length > 0) {
          overrides = {};
          match = prop.toString().match(/function.*?\(([\s\S]*?)\)/);
          if (match == null) {
            throw new Error("could not parse function arguments: " + (prop != null ? prop.toString() : void 0));
          }
          args = match[1].split(",").filter(filter).map(function(str) {
            return str.trim();
          });
          if (prop.inject == null) {
            prop.inject = args;
          }
          if (prop.name.length > 0) {
            prop.construct = function(a) {
              var fconstructor, nconstructor;
              fconstructor = prop;
              nconstructor = function() {
                return fconstructor.apply(this, a);
              };
              nconstructor.prototype = fconstructor.prototype;
              return new nconstructor();
            };
          }
          for (i in args) {
            r = args[i];
            overrides[r] = get(prop.inject[i]);
          }
        }
      }
      if (prop.inject != null) {
        if (prop.name.length > 0) {
          injector.register("__" + key, wrap(prop));
        } else {
          injector.register("__" + key, prop);
        }
        return injector.register(key, function() {
          var e, l, res;
          if (prop.name.length > 0) {
            args = [];
            for (l in overrides) {
              e = overrides[l];
              args.push(e());
            }
            if (singleton) {
              res = injector.get("__" + key).construct(args);
              injector.register(key, wrap(res));
            } else {
              res = construct(key, injector.get("__" + key), args)();
            }
          } else {
            for (l in overrides) {
              e = overrides[l];
              overrides[l] = e();
            }
            if (singleton) {
              res = injector.get("__" + key, overrides);
              injector.register(key, wrap(res));
            } else {
              res = create(key, "__" + key, overrides)();
            }
          }
          return res;
        });
      } else {
        if (singleton) {
          return injector.register(key, prop);
        } else {
          injector.register("__" + key, prop);
          return injector.register(key, function() {
            return create(key, "__" + key, {})();
          });
        }
      }
    };
    dir = path.resolve(appDir);
    glob("" + dir + "/**/*" + ext, {
      sync: true
    }, function(err, files) {
      var excluded, file, mdl, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = files.length; _i < _len; _i++) {
        file = files[_i];
        excluded = path.relative(dir, file);
        if (excluded === ("bootstrap" + ext) || excluded === ("chainware" + ext)) {
          continue;
        }
        mdl = require(file);
        _results.push(_.forOwn(mdl, function(prop, key) {
          if ((prop.exclude != null) && prop.exclude === true) {
            return;
          }
          if (prop.namespace != null) {
            key = "" + prop.namespace + "." + key;
          }
          return resolve(prop, key);
        }));
      }
      return _results;
    });
    for (k in injectors) {
      v = injectors[k];
      if (k !== name) {
        i = v.get('$injectors');
        i[name] = injector;
      }
    }
    if ((chainware != null ? chainware.afterLoad : void 0) != null) {
      return injector.resolve(chainware.afterLoad);
    }
  };
  initialized = false;
  init = function() {
    var cm, es, k, m, mount, store, v;
    if (initialized) {
      return;
    }
    initialized = true;
    load();
    if ((chainware != null ? chainware.beforeInit : void 0) != null) {
      injector.resolve(chainware.beforeInit);
    }
    if ((pkg.dependencies['connect-mongo'] != null) && (pkg.dependencies['express-session'] != null)) {
      if (config.middleware['express-session'] && config.middleware['connect-mongo']) {
        if (_.isBoolean(config.middleware['connect-mongo'])) {
          config.middleware['connect-mongo'] = {};
        }
        config.middleware['connect-mongo']['db'] = injector.get('$connection').db;
        cm = require("" + relativeProjectDir + "/node_modules/connect-mongo");
        es = require("" + relativeProjectDir + "/node_modules/express-session");
        store = new (cm(es))(config.middleware['connect-mongo']);
        if (_.isBoolean(config.middleware['express-session'])) {
          config.middleware['express-session'] = {};
        }
        config.middleware['express-session']['store'] = store;
      }
    }
    if (config.router.strict) {
      app.enable('strict routing');
    }
    if (config.router.caseSensitive) {
      app.enable('case sensitive routing');
    }
    if ((chainware != null ? chainware.beforeMiddleware : void 0) != null) {
      injector.resolve(chainware.beforeMiddleware);
    }
    app.use(function(req, res, next) {
      res.removeHeader('X-Powered-By');
      return next();
    });
    if ((pkg.dependencies['compression'] != null) && config.middleware['compression']) {
      if ((chainware != null ? chainware.beforeCompression : void 0) != null) {
        injector.resolve(chainware.beforeCompression);
      }
      m = require("" + relativeProjectDir + "/node_modules/compression");
      if (!_.isBoolean(config.middleware['compression'])) {
        app.use(m(config.middleware['compression']));
      } else {
        app.use(m());
      }
      if ((chainware != null ? chainware.afterCompression : void 0) != null) {
        injector.resolve(chainware.afterCompression);
      }
    }
    if ((pkg.dependencies['serve-favicon'] != null) && config.middleware['serve-favicon']) {
      if ((chainware != null ? chainware.beforeServeFavicon : void 0) != null) {
        injector.resolve(chainware.beforeServeFavicon);
      }
      m = require("" + relativeProjectDir + "/node_modules/serve-favicon");
      if (!_.isBoolean(config.middleware['serve-favicon'])) {
        app.use(m("" + publicDir + "/favicon.ico", config.middleware['serve-favicon']));
      } else {
        app.use(m("" + publicDir + "/favicon.ico"));
      }
      if ((chainware != null ? chainware.afterServeFavicon : void 0) != null) {
        injector.resolve(chainware.afterServeFavicon);
      }
    }
    if ((chainware != null ? chainware.beforeStatic : void 0) != null) {
      injector.resolve(chainware.beforeStatic);
    }
    for (k in injectors) {
      v = injectors[k];
      dir = v.get('$dir');
      name = v.get('$name');
      app.use("/public/" + name, express["static"](dir["public"], {
        maxAge: config["static"].expiry
      }));
    }
    if ((chainware != null ? chainware.afterStatic : void 0) != null) {
      injector.resolve(chainware.afterStatic);
    }
    if ((pkg.dependencies['cookie-parser'] != null) && config.middleware['cookie-parser']) {
      if ((chainware != null ? chainware.beforeCookieParser : void 0) != null) {
        injector.resolve(chainware.beforeCookieParser);
      }
      m = require("" + relativeProjectDir + "/node_modules/cookie-parser");
      if (!_.isBoolean(config.middleware['cookie-parser'])) {
        app.use(m(config.middleware['cookie-parser']));
      } else {
        app.use(m());
      }
      if ((chainware != null ? chainware.afterCookieParser : void 0) != null) {
        injector.resolve(chainware.afterCookieParser);
      }
    }
    if ((pkg.dependencies['body-parser'] != null) && config.middleware['body-parser']) {
      if ((chainware != null ? chainware.beforeBodyParser : void 0) != null) {
        injector.resolve(chainware.beforeBodyParser);
      }
      m = require("" + relativeProjectDir + "/node_modules/body-parser");
      app.use(m());
      if ((chainware != null ? chainware.afterBodyParser : void 0) != null) {
        injector.resolve(chainware.afterBodyParser);
      }
    }
    if ((pkg.dependencies['express-validator'] != null) && config.middleware['express-validator']) {
      if ((chainware != null ? chainware.beforeExpressValidator : void 0) != null) {
        injector.resolve(chainware.beforeExpressValidator);
      }
      m = require("" + relativeProjectDir + "/node_modules/express-validator");
      if (!_.isBoolean(config.middleware['express-validator'])) {
        app.use(m(config.middleware['express-validator']));
      } else {
        app.use(m());
      }
      if ((chainware != null ? chainware.afterExpressValidator : void 0) != null) {
        injector.resolve(chainware.afterExpressValidator);
      }
    }
    if ((pkg.dependencies['method-override'] != null) && config.middleware['method-override']) {
      if ((chainware != null ? chainware.beforeMethodOverride : void 0) != null) {
        injector.resolve(chainware.beforeMethodOverride);
      }
      m = require("" + relativeProjectDir + "/node_modules/method-override");
      app.use(m());
      if ((chainware != null ? chainware.afterMethodOverride : void 0) != null) {
        injector.resolve(chainware.afterMethodOverride);
      }
    }
    if ((pkg.dependencies['express-session'] != null) && config.middleware['express-session']) {
      if ((chainware != null ? chainware.beforeExpressSession : void 0) != null) {
        injector.resolve(chainware.beforeExpressSession);
      }
      m = require("" + relativeProjectDir + "/node_modules/express-session");
      if (!_.isBoolean(config.middleware['express-session'])) {
        app.use(m(config.middleware['express-session']));
      } else {
        app.use(m());
      }
      if ((chainware != null ? chainware.afterExpressSession : void 0) != null) {
        injector.resolve(chainware.afterExpressSession);
      }
    }
    if ((pkg.dependencies['view-helpers'] != null) && config.middleware['view-helpers']) {
      if ((chainware != null ? chainware.beforeViewHelpers : void 0) != null) {
        injector.resolve(chainware.beforeViewHelpers);
      }
      m = require("" + relativeProjectDir + "/node_modules/view-helpers");
      app.use(m(name));
      if ((chainware != null ? chainware.afterViewHelpers : void 0) != null) {
        injector.resolve(chainware.afterViewHelpers);
      }
    }
    if ((pkg.dependencies['connect-flash'] != null) && config.middleware['connect-flash']) {
      if ((chainware != null ? chainware.beforeConnectFlash : void 0) != null) {
        injector.resolve(chainware.beforeConnectFlash);
      }
      m = require("" + relativeProjectDir + "/node_modules/connect-flash");
      app.use(m());
      if ((chainware != null ? chainware.afterConnectFlash : void 0) != null) {
        injector.resolve(chainware.afterConnectFlash);
      }
    }
    for (k in injectors) {
      v = injectors[k];
      v.get('__route')();
    }
    mount = injector.get('$mount');
    app.use(mount, injector.get('$router'));
    if ((chainware != null ? chainware.afterMiddleware : void 0) != null) {
      injector.resolve(chainware.afterMiddleware);
    }
    if ((pkg.dependencies['errorhandler'] != null) && config.middleware['errorhandler']) {
      if ((chainware != null ? chainware.beforeErrorHandler : void 0) != null) {
        injector.resolve(chainware.beforeErrorHandler);
      }
      m = require("" + relativeProjectDir + "/node_modules/errorhandler");
      app.use(m());
      if ((chainware != null ? chainware.afterErrorHandler : void 0) != null) {
        injector.resolve(chainware.afterErrorHandler);
      }
    }
    if ((chainware != null ? chainware.afterInit : void 0) != null) {
      injector.resolve(chainware.afterInit);
    }
    return injector;
  };
  return {
    injector: injector,
    load: load,
    init: init
  };
};

module.exports.server = function($dir, $ext, $config, $injector, $emitter, $env) {
  var boostrap, bootstrap, listen, relativeAppDir, server, vhosts;
  relativeAppDir = path.relative(__dirname, $dir.app);
  if ($config.router.strict) {
    server.enable('strict routing');
  }
  if ($config.router.caseSensitive) {
    server.enable('case sensitive routing');
  }
  boostrap = fs.existsSync("" + $dir.app + "/bootstrap" + $ext);
  if (bootstrap) {
    bootstrap = require("" + relativeAppDir + "/bootstrap");
  }
  if (bootstrap && (bootstrap.vhosts != null)) {
    server = require('express')();
    vhosts = $injector.resolve(bootstrap.vhosts);
    server = vhosted(server, $dir.project, vhosts);
  } else {
    server = $injector.get('$app');
  }
  $injector.register('$server', function() {
    return server;
  });
  listen = function() {
    var http, port;
    if (bootstrap && (bootstrap.server != null)) {
      server = $injector.resolve(require("" + relativeAppDir + "/bootstrap").server);
    } else {
      http = require('http');
      port = process.env.PORT || $config.port;
      server = http.createServer(server).listen(port, function() {
        return console.log('Server listening on port ' + port);
      });
    }
    return server.on('listening', function() {
      return fs.writeFileSync("" + $dir.project + "/.tmp/reload", 'reload');
    });
  };
  if ($env === 'production') {
    return $emitter.on('mongoose-connected', function() {
      return listen();
    });
  } else {
    return listen();
  }
};
